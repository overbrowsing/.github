name: Update README with Climate Clock

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'

permissions: write-all

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Fetch Climate Clock data
      run: |
        curl -s https://api.climateclock.world/v2/widget/clock.json > clock_data.json

    - name: Extract data and update README
      run: |
        # Extract the ISO 8601 timestamp
        time_remaining=$(jq -r '.data.modules.carbon_deadline_1.timestamp' clock_data.json)
    
        time_left_formatted=$(date -d "$(echo $time_remaining | sed 's/T/ /;s/+.*//')" "+%B %d, %Y")
    
        top_news=$(jq -r '.data.modules.newsfeed_1.newsfeed[0:5] | map("- [\(.headline): \(.source)](\(.link))") | join("\n")' clock_data.json)
    
        sed -i "/<!-- clock-time -->/,/<!-- \/clock-time -->/c\<!-- clock-time -->\nTime Left to Limit Global Warming: $time_left_formatted\n<!-- /clock-time -->" profile/README.md
        sed -i "/<!-- clock-news -->/,/<!-- \/clock-news -->/c\<!-- clock-news -->\n$top_news\n<!-- /clock-news -->" profile/README.md

    - name: Commit and push changes
      uses: EndBug/add-and-commit@v7
      with:
        message: "Update README with latest Climate Clock data"
        add: "profile/README.md"
        author_name: "GitHub Actions"
        author_email: "github-actions@github.com"
        push: true
